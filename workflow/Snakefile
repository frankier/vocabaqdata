from os.path import join as pjoin
from itertools import chain


def run_R(script_path, *args):
    return shell("R " + pjoin(workflow.current_basedir, script_path) + " " + " ".join(args))


def cnf(name, val):
    globals()[name] = config.setdefault(name, val)


# Directories
cnf("WORK", "work")

# Dependencies
cnf("BINEXTRA", pjoin(WORK, "bin"))
cnf("TABULA_URL", "https://github.com/tabulapdf/tabula-java/releases/download/v1.0.4/tabula-1.0.4-jar-with-dependencies.jar")
cnf("TABULA_JAR", pjoin(BINEXTRA, "tabula.jar"))


class Dataset:
    def __init__(self, name, output, src_name=None):
        self.name = name
        if isinstance(src_name, str):
            src_name = [src_name]
        elif src_name is None:
            src_name = []
        self.src_name = src_name
        self.src = [globals()[name] for src_name in src_name]
        self._output = output

    def _available(self):
        return all((src != "/does/not/exist" for src in self.src))

    @property
    def output(self):
        if self._available():
            return [self._output]
        else:
            return []

    def __str__(self):
        if self._available():
            stat = "YES"
        else:
            names = "; ".join(self.src_name)
            stat = f"NO (pass -C {names} to build)"
        return "{:>30} {}".format(self.name, stat)


def all_input(wc):
    print(" *** ")
    print()
    for dataset in DATASETS:
        print(str(dataset))
    print()
    print(" *** ")
    res = list(chain(*(dataset.output for dataset in DATASETS)))
    return res


rule all:
    input: all_input


rule all_svl12k:
    input:
        SVL12K_DF, SVL12K_DF
    output:
        touch(pjoin(WORK, ".svl12k_all"))


rule all_evkd1:
    input:
        EVKD1_RESP_DF
    output:
        touch(pjoin(WORK, ".svl12k_all"))


## Dependencies
rule get_tabula:
    output:
        TABULA_JAR
    shell:
        "mkdir -p " + BINEXTRA + " && " +
        "cd " + BINEXTRA + " && " +
        "wget " + TABULA_URL + " -O " + TABULA_JAR


## Datasets
include: "datasets/evkd1.smk"
include: "datasets/svl12k.smk"
include: "datasets/testyourvocab.smk"
include: "datasets/ecp.smk"
include: "datasets/elp.smk"
include: "datasets/flp.smk"

DATASETS = [
    Dataset("SVL12K", rules.all_svl12k.output, "SVL12K_RAW"),
    Dataset("EVKD1", rules.all_evkd1.output, "EVKD1_RAW"),
    Dataset("TESTYOURVOCAB", rules.import_testyourvocab_all.output, ["TESTYOURVOCAB_RANKS", "TESTYOURVOCAB_NATIVE_RAW", "TESTYOURVOCAB_NONNATIVE_RAW"]),
    Dataset("ECP", rules.import_ecp.output),
    Dataset("ELP", rules.import_elp.output),
    Dataset("FLP", rules.import_flp.output),
]
